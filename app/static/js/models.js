// Generated by CoffeeScript 1.6.3
(function() {
  $(function() {
    /* Data Models*/

    window.models.Query = Backbone.Model.extend({
      url: function() {
        return "/queries/" + (this.get("id") || this.get("title"));
      },
      external_url: '/externalNews',
      initialize: function(attrs, options) {
        _.bindAll(this, "getYahooNews", "getGoogleNews", "exists", "addStory");
        this.map = window.mapObj;
        try {
          return this.get("stories").parent_map = options.map;
        } catch (_error) {}
      },
      defaults: function() {
        return {
          stories: new collections.Stories
        };
      },
      parse: function(model) {
        var obj, stories;
        if (model.query != null) {
          obj = model.query;
        } else {
          obj = model;
        }
        this.value = obj.title;
        this.tokens = [obj.title];
        stories = new collections.Stories();
        _.each(obj.stories, function(story) {
          return stories.add(new models.Story(story, {
            parse: true
          }));
        });
        obj.stories = stories;
        if (obj.created != null) {
          obj.created = new Date(obj.created);
        }
        if (obj.last_query != null) {
          obj.last_query = new Date(obj.last_query);
        }
        return obj;
      },
      exists: function(exists_callback, fails_callback) {
        var querytitle, self;
        querytitle = this.get("title");
        self = this;
        $.get("/queries/" + querytitle, {}, function(response) {
          try {
            response = JSON.parse(response);
          } catch (_error) {}
          cc(response);
          if (response.exists !== false && (exists_callback != null)) {
            self.id = response.id;
            self.set("id", response.id);
            console.log(self);
            return exists_callback(querytitle);
          } else if (fails_callback != null) {
            return fails_callback(self, new models.Query(response, {
              parse: true
            }));
          }
        });
        return this;
      },
      favorite: function() {
        var query_id, user_id;
        user.get("queries").add(this);
        user_id = window.user.id;
        query_id = this.id || this.get("id");
        return $.post("/favorite", {
          user_id: user_id,
          query_id: query_id
        }, function(resp) {
          resp = JSON.parse(resp);
          cc(resp);
          return cc("THIS MAP HAS BEEN FAVORITED");
        });
      },
      addStory: function(story) {
        var id, stories, title;
        stories = this.get("stories");
        story.date = new Date(story.date);
        title = story.title.toLowerCase().stripHTML();
        if (!stories._byTitle.hasOwnProperty(title)) {
          stories.add(story = new models.Story(story));
          id = this.get("id") || this.id;
          if (id) {
            story.set("query_id", id);
          }
          stories._byTitle[title] = story;
          story.plot();
        } else {
          cc("story exists");
        }
        return this;
      },
      getGoogleNews: function(start, done) {
        var query, self;
        cc("calling gnews");
        self = this;
        query = this.get("title");
        start || (start = 0);
        $.get(this.external_url, {
          source: 'google',
          q: query.toLowerCase(),
          start: start
        }, function(stories) {
          console.count("google news story set returned");
          stories = JSON.parse(stories);
          cc(stories);
          if ((start > 64 || !stories.length) && (done != null)) {
            done(0, null);
          }
          _.each(stories, self.addStory);
          if (start < 64) {
            return self.getGoogleNews(start + 8, done);
          }
        });
        return this;
      },
      getYahooNews: function(start, done) {
        var query, self;
        query = '"' + this.get("title").toLowerCase() + '"';
        start || (start = 0);
        self = this;
        return $.get(this.external_url, {
          source: 'yahoo',
          q: query,
          start: start
        }, function(stories) {
          var total;
          stories = JSON.parse(stories);
          console.count("yahoo news story set returned");
          total = 10;
          _.each(stories, self.addStory);
          if (start <= total) {
            self.getYahooNews(start + 50, done);
          } else if (done != null) {
            done(0, null);
          }
          return this;
        });
      },
      getFeedZilla: function(done) {
        var self;
        self = this;
        return $.get("http://api.feedzilla.com/v1/articles.json", {
          q: this.get("title"),
          count: 100
        }, function(response) {
          return _.each(response.articles, function(story) {
            cc("adding feedzilla sroy");
            return self.addStory(story, {
              map: {
                content: 'summary',
                publisher: 'source',
                date: function() {
                  return new Date(story.publish_date);
                },
                aggregator: function() {
                  return 'FeedZilla';
                }
              }
            });
          });
        });
      }
    });
    window.collections.Queries = Backbone.Collection.extend({
      model: models.Query,
      url: "/queries",
      parse: function(response) {
        return response.queries;
      }
    });
    window.models.Story = Backbone.Model.extend({
      url: function() {
        var url;
        url = "/stories";
        if (this.id) {
          url += "/" + this.id;
        }
        return url;
      },
      geocodeUrl: 'http://maps.googleapis.com/maps/api/geocode/json?sensor=true&address=',
      loading: false,
      defaults: {
        hasLoaded: false
      },
      initialize: function() {
        _.bindAll(this, "geocode");
        return this.on({
          "loading": function() {
            return this.loading = true;
          },
          "doneloading": function() {
            return this.loading = false;
          },
          "change:hasLocation": function(model, value) {
            if (value === true) {
              return this.collection._withLocation[this.get("title")] = this;
            }
          }
        });
      },
      hasLocation: function() {
        return (this.get("lat") != null) && this.get("lng");
      },
      plot: function() {
        window.mapObj.plot(this);
        return this;
      },
      geocode: function(address, callback) {
        var self;
        self = this;
        console.log(self);
        $.getJSON(this.geocodeUrl + encodeURIComponent(address), function(response) {
          var coords;
          try {
            coords = response.results[0].geometry.location;
            self.save({
              lat: coords.lat,
              lng: coords.lng,
              location: response.results[0].formatted_address
            }, {
              success: function(model, resp) {
                self.set("hasLocation", true);
                return self.plot();
              },
              error: function(model, resp) {}
            });
            if (callback != null) {
              return callback(true, coords);
            }
          } catch (_error) {
            console.log(_error);
            if (callback != null) {
              return callback(false, null);
            }
          }
        });
        return this;
      }
    });
    return (function() {
      var sortMethods;
      sortMethods = {
        "newest": function(story) {
          return story.get("date");
        },
        "oldest": function() {
          return -story.get("date");
        }
      };
      return window.collections.Stories = Backbone.Collection.extend({
        model: models.Story,
        _byTitle: {},
        _withLocation: {},
        initialize: function(opts) {
          if ((opts != null) && opts.parent_map) {
            this.parent_map = opts.parent_map;
          }
          this._byTitle = {};
          return this;
        },
        filterByDate: function(lodate, hidate) {
          var inrange, outrange, self;
          self = this;
          inrange = [];
          outrange = [];
          _.each(this.models, function(story) {
            var date, marker, markerObj;
            date = story.get("date");
            if (date instanceof Date === false) {
              story.set("date", new Date(date));
            }
            markerObj = story.marker;
            if (markerObj != null) {
              marker = markerObj.marker;
              if (date < hidate && date > lodate) {
                return inrange.push(marker);
              } else {
                return outrange.push(marker);
              }
            }
          });
          return {
            inrange: inrange,
            outrange: outrange
          };
        }
      });
    })();
  });

}).call(this);
