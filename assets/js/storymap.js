// Generated by CoffeeScript 1.6.3
(function() {
  window.GoogleMap = function(model) {
    var map;
    this.mapOptions = {
      center: new google.maps.LatLng(0, 0),
      zoom: 2,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map-canvas"), this.mapOptions);
    this.map = map;
    this.markers = [];
    this.infowindow = new google.maps.InfoWindow();
    if (model != null) {
      this.model = model;
    } else {
      this.model = null;
    }
    return this;
  };

  window.getGoogleNews = function(val, start) {
    return $.get("./getnews.php", {
      q: val || $search.val(),
      start: start
    }, function(data) {
      var end, i, json, _i, _ref;
      json = JSON.parse(data);
      if (json.responseDetails === "out of range start") {
        end = true;
        return false;
      }
      for (i = _i = 0, _ref = json.responseData.results.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
        getCalaisData(json.responseData.results[i]);
      }
      return true;
    });
  };

  window.getCalaisData = function(content) {
    var context;
    console.log("getting data");
    context = content.titleNoFormatting + content.content;
    $.get("./calais.php", {
      content: context
    }, function(data) {
      var el, json;
      json = JSON.parse(data);
      if (json == null) {
        return;
      }
      console.log(json.doc.info.docDate);
      for (el in json) {
        if (json[el].hasOwnProperty("resolutions")) {
          content.latitude = json[el].resolutions[0].latitude;
          content.longitude = json[el].resolutions[0].longitude;
          stories.push(content);
          StoryMap.plotStory(content);
          return;
        }
      }
    });
    return content;
  };

  window.makeUIDialog = function(message) {
    $(document.body).append("<div class='ui-dialog'>" + message + "</div>").addClass("active-message");
    return $(".ui-dialog").hide().fadeIn("fast", function() {
      return $(this).delay(8000).fadeOut(800, function() {
        $(this).remove();
        return $(document.body).removeClass("active-message");
      });
    });
  };

  window.GoogleMap.prototype.plotStory = function(story) {
    var display_string, marker, pt, that, xOff, yOff;
    xOff = Math.random() * 0.1;
    yOff = Math.random() * 0.1;
    pt = new google.maps.LatLng(parseInt(story.latitude) + xOff, parseInt(story.longitude) + yOff);
    display_string = "<h3><a target='_blank' href='" + story.unescapedUrl + "'>" + story.title + "</a></h3>" + "<p>" + story.content + "</p>";
    marker = new google.maps.Marker({
      position: pt,
      title: story.title
    });
    this.markers.push(marker);
    marker.setMap(this.map);
    that = this;
    return google.maps.event.addListener(marker, "click", function() {
      that.infowindow.setContent(display_string);
      return that.infowindow.open(that.map, this);
    });
  };

}).call(this);
